<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹ - Metaåºƒå‘Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        /* ğŸ”¥ ä¿®æ­£: å·¦ä¸Šã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã */
        .main-content {
            padding: 20px;
            background: #f8fafc; /* å…ƒã®è–„ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
        }
        
        .page-header-section {
            margin-bottom: 20px;
        }
        
        .alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .alert-header h1 {
            color: #1f2937; /* å…ƒã®é»’æ–‡å­— */
            font-size: 28px;
            font-weight: 600;
            margin: 0;
            /* ğŸ”¥ é‡è¦: å·¦ä¸Šã®ä½ç½®ã‚’å›ºå®š */
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .alert-status {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #6b7280;
            /* ğŸ”¥ é‡è¦: å³å´ã«é©åˆ‡ã«é…ç½® */
            flex-shrink: 0;
            text-align: right;
        }
        
        .alert-section {
            margin-bottom: 30px;
        }
        
        .alert-section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1f2937; /* å…ƒã®é»’æ–‡å­— */
            /* ğŸ”¥ é‡è¦: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½ç½®å›ºå®š */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #10b981;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .alert-card.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .alert-card.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .alert-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .alert-type {
            font-size: 16px;
            font-weight: 500;
            color: #374151;
        }
        
        .alert-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .alert-message {
            color: #374151;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .no-alerts {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            padding: 40px 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #d1d5db;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ©ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆå‰Šé™¤å¾Œã®èª¿æ•´ */
        .main-alert-section {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 200px; /* æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
        }

        .main-alert-section h2 {
            margin: 0 0 20px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-header h2 {
            margin: 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
        }

        .edit-goals-button {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .edit-goals-button:hover {
            background-color: #2563eb;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: #374151;
        }

        .modal-body {
            padding: 20px;
        }

        .goal-settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .goal-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .goal-label {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .goal-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .goal-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-unit {
            color: #6b7280;
            font-size: 14px;
            min-width: 30px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .cancel-button, .save-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .cancel-button {
            background-color: #f3f4f6;
            color: #374151;
        }

        .cancel-button:hover {
            background-color: #e5e7eb;
        }

        .save-button {
            background-color: #3b82f6;
            color: white;
        }

        .save-button:hover {
            background-color: #2563eb;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading p {
            font-size: 16px;
            margin: 0;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .alert-item.attention-alert {
            border-left: 4px solid #f59e0b;
        }

        .alert-item.attention-alert .alert-icon {
            color: #f59e0b;
        }

        /* ã‚´ãƒ¼ãƒ«è¨­å®šã®è¿½åŠ é …ç›®å¯¾å¿œ */
        .goals-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            min-height: 50px;
        }

        /* ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .goal-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        .save-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* ğŸ”¥ é‡è¦: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã§å·¦ä¸Šå´©ã‚Œã‚’é˜²ã */
        @media (max-width: 768px) {
            .alert-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .alert-status {
                align-self: flex-end;
            }

            .settings-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .edit-goals-button {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨å®Œå…¨çµ±ä¸€ï¼‰ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Metaåºƒå‘Šãƒ¬ãƒãƒ¼ãƒˆ</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <a href="/alerts" class="nav-item active">ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹</a>
                <a href="/alert-history" class="nav-item">ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´</a>
                <a href="/improvement-tasks" class="nav-item">ç¢ºèªäº‹é …</a>
                <a href="/improvement-strategies" class="nav-item">æ”¹å–„æ–½ç­–</a>
                <a href="/chatwork-test" class="nav-item">ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ</a>
            </nav>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆğŸ”¥ å·¦ä¸Šã®å´©ã‚Œã‚’ä¿®æ­£ï¼‰ -->
        <main class="main-content">
            <!-- ğŸ”¥ ä¿®æ­£: é©åˆ‡ãªãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
            <div class="page-header-section">
                <div class="alert-header">
                    <h1>ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹</h1>
                    <div class="alert-status">
                        <span>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ©ãƒ¼ãƒˆ: <span id="active-count">-</span>ä»¶</span>
                        <span>æœ€çµ‚ãƒã‚§ãƒƒã‚¯: <span id="last-check">-</span></span>
                    </div>
                </div>
            </div>

                <!-- æ³¨æ„ã‚¢ãƒ©ãƒ¼ãƒˆ - ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆå‰Šé™¤å¾Œã®ç¾ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                <div class="alert-section main-alert-section">
                    <h2>âš ï¸ æ³¨æ„ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
                    <div id="warning-alerts" class="loading">
                        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>

                <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š -->
                <div class="alert-section">
                    <div class="settings-header">
                        <h2>âš™ï¸ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š</h2>
                        <button 
                            class="edit-goals-button"
                            onclick="openGoalSettings()"
                        >
                            ã‚´ãƒ¼ãƒ«è¨­å®šã‚’ç·¨é›†
                        </button>
                    </div>
                    <div id="alert-settings">
                        <div class="alert-card">
                            <div class="alert-type">ç¾åœ¨ã®ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—</div>
                            <div class="alert-message" id="current-goal">è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                        <div class="alert-card">
                            <div class="alert-type">ç›£è¦–é …ç›®</div>
                            <div class="alert-message">
                                â€¢ äºˆç®—æ¶ˆåŒ–ç‡: 80%ä»¥ä¸‹ãŒ3æ—¥é–“ç¶™ç¶š<br>
                                â€¢ CTR: åŸºæº–å€¤ä»¥ä¸‹ãŒ3æ—¥é–“ç¶™ç¶š<br>
                                â€¢ CV: 0ä»¶ç¶™ç¶šã§ç™ºç”Ÿ<br>
                                â€¢ CPA: ç›®æ¨™å€¤120%è¶…éãŒ2æ—¥é–“ç¶™ç¶š<br>
                                â€¢ æ—¥äºˆç®—: è¨­å®šå€¤ä»¥ä¸‹ã§ç™ºç”Ÿ<br>
                                â€¢ CPM: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰+500å††ãŒ3æ—¥é–“ç¶™ç¶š
                            </div>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <!-- ã‚´ãƒ¼ãƒ«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="goalSettingsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš™ï¸ ã‚´ãƒ¼ãƒ«è¨­å®š</h3>
                <button class="close-button" onclick="closeGoalSettings()">Ã—</button>
            </div>
            
            <div class="modal-body">
                <div class="goal-settings-form">
                    <div class="goal-input-group">
                        <label class="goal-label">äºˆç®—æ¶ˆåŒ–ç‡</label>
                        <div class="input-with-unit">
                            <input type="number" id="goal-budget-rate" value="80" min="0" max="100" class="goal-input">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-label">CTR</label>
                        <div class="input-with-unit">
                            <input type="number" id="goal-ctr" value="2.0" min="0" step="0.1" class="goal-input">
                            <span class="input-unit">%</span>
                        </div>
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-label">CV</label>
                        <div class="input-with-unit">
                            <input type="number" id="goal-cv" value="1" min="0" class="goal-input">
                            <span class="input-unit">ä»¶</span>
                        </div>
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-label">CPA</label>
                        <div class="input-with-unit">
                            <input type="number" id="goal-cpa" value="10000" min="0" class="goal-input">
                            <span class="input-unit">å††</span>
                        </div>
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-label">æ—¥äºˆç®—</label>
                        <div class="input-with-unit">
                            <input type="number" id="goal-daily-budget" value="50000" min="0" class="goal-input">
                            <span class="input-unit">å††</span>
                        </div>
                    </div>
                    <div class="goal-input-group">
                        <label class="goal-label">CPM</label>
                        <div class="input-with-unit">
                            <input type="number" id="goal-cpm" value="1000" min="0" class="goal-input">
                            <span class="input-unit">å††</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="cancel-button" onclick="closeGoalSettings()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button class="save-button" onclick="saveGoalSettings()">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–');
            await initializeAlertsPage();
            
            // 5åˆ†æ¯ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            setInterval(loadAlertData, 5 * 60 * 1000);
        });

        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        async function initializeAlertsPage() {
            try {
                await loadGoals();
                await loadAlertData();
            } catch (error) {
                console.error('ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚´ãƒ¼ãƒ«è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆsetup.jsonã‹ã‚‰å–å¾—ï¼‰
        async function loadGoals() {
            try {
                // ã¾ãš setup.json ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
                const response = await fetch('/api/check-saved-meta-data');
                const setupData = await response.json();
                
                let currentGoals = {};
                let goalType = '';
                
                if (setupData.success && setupData.hasConfig) {
                    // setup.json ã‹ã‚‰ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ã¨ç›®æ¨™å€¤ã‚’å–å¾—
                    goalType = setupData.data.goal?.type || '';
                    
                    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¨åŒã˜ goalTargets ã‚’ä½¿ç”¨
                    const goalTargets = {
                        toC_newsletter: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 2.5,
                            'CV': 1,
                            'CPA': 2000,
                            'æ—¥äºˆç®—': 1000,
                            'CPM': 1000
                        },
                        toC_line: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 2.5,
                            'CV': 1,
                            'CPA': 1000,
                            'æ—¥äºˆç®—': 1000,
                            'CPM': 800
                        },
                        toC_phone: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 2.0,
                            'CV': 1,
                            'CPA': 3000,
                            'æ—¥äºˆç®—': 1500,
                            'CPM': 1200
                        },
                        toC_purchase: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 1.8,
                            'CV': 1,
                            'CPA': 5000,
                            'æ—¥äºˆç®—': 2000,
                            'CPM': 1500
                        },
                        toB_newsletter: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 1.5,
                            'CV': 1,
                            'CPA': 15000,
                            'æ—¥äºˆç®—': 3000,
                            'CPM': 2000
                        },
                        toB_line: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 1.5,
                            'CV': 1,
                            'CPA': 12000,
                            'æ—¥äºˆç®—': 2500,
                            'CPM': 1800
                        },
                        toB_phone: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 1.2,
                            'CV': 1,
                            'CPA': 20000,
                            'æ—¥äºˆç®—': 4000,
                            'CPM': 2500
                        },
                        toB_purchase: {
                            'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                            'CTR': 1.0,
                            'CV': 1,
                            'CPA': 30000,
                            'æ—¥äºˆç®—': 5000,
                            'CPM': 3000
                        }
                    };
                    
                    if (goalTargets[goalType]) {
                        currentGoals = goalTargets[goalType];
                    }
                }
                
                // localStorage ã®è¨­å®šã§ä¸Šæ›¸ãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸå ´åˆï¼‰
                const storedGoals = localStorage.getItem('alert_goals');
                if (storedGoals) {
                    const customGoals = JSON.parse(storedGoals);
                    currentGoals = { ...currentGoals, ...customGoals };
                }
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                const defaultGoals = {
                    'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                    'CTR': 2.0,
                    'CV': 1,
                    'CPA': 10000,
                    'æ—¥äºˆç®—': 50000,
                    'CPM': 1000
                };
                
                if (Object.keys(currentGoals).length === 0) {
                    currentGoals = defaultGoals;
                }
                
                // ç¾åœ¨ã®ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ã‚‚è¡¨ç¤ºã«åæ˜ 
                updateCurrentGoalDisplay(currentGoals, goalType);
                return currentGoals;
            } catch (error) {
                console.error('ã‚´ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const defaultGoals = {
                    'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                    'CTR': 2.0,
                    'CV': 1,
                    'CPA': 10000,
                    'æ—¥äºˆç®—': 50000,
                    'CPM': 1000
                };
                updateCurrentGoalDisplay(defaultGoals);
                return defaultGoals;
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAlertData() {
            try {
                console.log('ã‚¢ãƒ©ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                
                // å®Ÿéš›ã®ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´APIã‹ã‚‰å–å¾—
                try {
                    const alertResponse = await fetch('/api/alert-history');
                    const alertData = await alertResponse.json();
                    
                    if (alertData.success && alertData.history && alertData.history.length > 0) {
                        console.log('ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´APIã‹ã‚‰å–å¾—æˆåŠŸ:', alertData.history.length + 'ä»¶');
                        updateAlertDisplay(alertData.history.slice(0, 10)); // æœ€æ–°10ä»¶è¡¨ç¤º
                        updateStatus(alertData.history, alertData.generatedAt);
                        return;
                    }
                } catch (apiError) {
                    console.warn('ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´APIã‹ã‚‰ã®å–å¾—å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Ÿè¡Œ:', apiError);
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
                console.log('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ');
                
                // ã¾ãšã‚´ãƒ¼ãƒ«è¨­å®šã‚’å–å¾—
                const goals = await loadGoals();
                
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå®Ÿéš›ã®APIã¾ãŸã¯ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ï¼‰
                const dashboardData = await getDashboardData();
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
                const currentAlerts = checkForAlerts(dashboardData, goals);
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                updateAlertDisplay(currentAlerts);
                updateStatus(currentAlerts, new Date());
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã«è¿½åŠ 
                currentAlerts.forEach(alert => {
                    addToAlertHistory(alert);
                });
                
            } catch (error) {
                console.error('ã‚¢ãƒ©ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function getDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                const data = await response.json();
                
                if (data.success && data.data) {
                    return {
                        budgetConsumption: data.data.budgetRate, // å®Ÿéš›ã®äºˆç®—æ¶ˆåŒ–ç‡
                        ctr: data.data.ctr, // å®Ÿéš›ã®CTR
                        cv: data.data.conversions, // å®Ÿéš›ã®CVæ•°
                        cpa: data.data.cpa, // å®Ÿéš›ã®CPA
                        dailyBudget: data.data.dailyBudget || 45000, // å®Ÿéš›ã®æ—¥äºˆç®—
                        cpm: data.data.cpm // å®Ÿéš›ã®CPM
                    };
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
                    return {
                        budgetConsumption: 65,
                        ctr: 1.5,
                        cv: 0,
                        cpa: 12000,
                        dailyBudget: 45000,
                        cpm: 1200
                    };
                }
            } catch (error) {
                console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return {
                    budgetConsumption: 65,
                    ctr: 1.5,
                    cv: 0,
                    cpa: 12000,
                    dailyBudget: 45000,
                    cpm: 1200
                };
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
        function checkForAlerts(data, goals) {
            const alerts = [];
            const currentTime = new Date().toISOString();
            
            try {
                // äºˆç®—æ¶ˆåŒ–ç‡ãƒã‚§ãƒƒã‚¯
                if (data.budgetConsumption && goals['äºˆç®—æ¶ˆåŒ–ç‡'] && 
                    data.budgetConsumption < goals['äºˆç®—æ¶ˆåŒ–ç‡']) {
                    // ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼: APIå–å¾—æ—¥äºˆç®—ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ä½¿ç”¨
                    let budgetInfo = '';
                    if (data.actualDailyBudget && data.actualDailyBudget > 0) {
                        budgetInfo = `APIå–å¾—æ—¥äºˆç®—: ${data.actualDailyBudget.toLocaleString()}å††`;
                    } else if (goals['æ—¥äºˆç®—'] && goals['æ—¥äºˆç®—'] > 0) {
                        budgetInfo = `ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæ—¥äºˆç®—: ${goals['æ—¥äºˆç®—'].toLocaleString()}å††`;
                    }
                    
                    let message = `äºˆç®—æ¶ˆåŒ–ç‡ãŒ${goals['äºˆç®—æ¶ˆåŒ–ç‡']}%ä»¥ä¸‹ã®${data.budgetConsumption}%ãŒ3æ—¥é–“ç¶šã„ã¦ã„ã¾ã™`;
                    if (budgetInfo) {
                        message += `ï¼ˆ${budgetInfo}ï¼‰`;
                    }
                    
                    alerts.push({
                        id: `budget-${Date.now()}`,
                        metric: 'äºˆç®—æ¶ˆåŒ–ç‡',
                        message: message,
                        level: 'medium',
                        timestamp: currentTime,
                    });
                }

                // CTRãƒã‚§ãƒƒã‚¯
                if (data.ctr && goals['CTR'] && data.ctr < goals['CTR']) {
                    alerts.push({
                        id: `ctr-${Date.now()}`,
                        metric: 'CTR',
                        message: `CTRãŒ${goals['CTR']}%ä»¥ä¸‹ã®${data.ctr}%ãŒ3æ—¥é–“ç¶šã„ã¦ã„ã¾ã™`,
                        level: 'medium',
                        timestamp: currentTime,
                    });
                }

                // CVãƒã‚§ãƒƒã‚¯
                if (data.cv !== undefined && goals['CV'] && data.cv < goals['CV']) {
                    alerts.push({
                        id: `cv-${Date.now()}`,
                        metric: 'CV',
                        message: `CVæ•°ãŒ${goals['CV']}ä»¶ä»¥ä¸‹ã®${data.cv}ä»¶ãŒç¶šã„ã¦ã„ã¾ã™`,
                        level: 'high',
                        timestamp: currentTime,
                    });
                }

                // CPAãƒã‚§ãƒƒã‚¯ï¼ˆ120%åŸºæº–ï¼‰
                if (data.cpa && goals['CPA']) {
                    const thresholdCPA = goals['CPA'] * 1.2; // 120%åŸºæº–
                    if (data.cpa > thresholdCPA) {
                        alerts.push({
                            id: `cpa-${Date.now()}`,
                            metric: 'CPA',
                            message: `CPAãŒç›®æ¨™ã®120%ï¼ˆ${Math.round(thresholdCPA).toLocaleString()}å††ï¼‰ã‚’è¶…ãˆãŸ${Math.round(data.cpa).toLocaleString()}å††ãŒ2æ—¥é–“ç¶šã„ã¦ã„ã¾ã™`,
                            level: 'high',
                            timestamp: currentTime,
                        });
                    }
                }

                // æ—¥äºˆç®—ãƒã‚§ãƒƒã‚¯
                if (data.dailyBudget && goals['æ—¥äºˆç®—'] && data.dailyBudget < goals['æ—¥äºˆç®—']) {
                    alerts.push({
                        id: `daily-budget-${Date.now()}`,
                        metric: 'æ—¥äºˆç®—',
                        message: `æ—¥äºˆç®—ãŒ${goals['æ—¥äºˆç®—'].toLocaleString()}å††ä»¥ä¸‹ã®${data.dailyBudget.toLocaleString()}å††ã«ãªã£ã¦ã„ã¾ã™`,
                        level: 'medium',
                        timestamp: currentTime
                    });
                }

                // CPMãƒã‚§ãƒƒã‚¯
                if (data.cpm && goals['CPM'] && data.cpm > goals['CPM']) {
                    alerts.push({
                        id: `cpm-${Date.now()}`,
                        metric: 'CPM',
                        message: `CPMãŒ${goals['CPM'].toLocaleString()}å††ä»¥ä¸Šã®${data.cpm.toLocaleString()}å††ã«ãªã£ã¦ã„ã¾ã™`,
                        level: 'medium',
                        timestamp: currentTime
                    });
                }

            } catch (error) {
                console.error('ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
            }

            return alerts;
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã«è¿½åŠ 
        function addToAlertHistory(alert) {
            try {
                const history = JSON.parse(localStorage.getItem('alert_history') || '[]');
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜ãƒ¡ãƒˆãƒªãƒƒã‚¯ã®ç›´è¿‘ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¨æ¯”è¼ƒï¼‰
                const isDuplicate = history.some(item => 
                    item.metric === alert.metric && 
                    Math.abs(new Date(item.timestamp) - new Date(alert.timestamp)) < 3600000 // 1æ™‚é–“ä»¥å†…
                );
                
                if (!isDuplicate) {
                    history.unshift(alert);
                    
                    // éå»30æ—¥åˆ†ã®ã¿ä¿æŒ
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const filteredHistory = history.filter(item => 
                        new Date(item.timestamp) > thirtyDaysAgo
                    );
                    
                    localStorage.setItem('alert_history', JSON.stringify(filteredHistory));
                }
            } catch (error) {
                console.error('ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºæ›´æ–°
        function updateAlertDisplay(alerts) {
            const warningContainer = document.getElementById('warning-alerts');
            
            if (!warningContainer) {
                console.error('è­¦å‘Šã‚¢ãƒ©ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (alerts.length > 0) {
                warningContainer.innerHTML = alerts.map(alert => createAlertCard(alert, 'warning')).join('');
            } else {
                warningContainer.innerHTML = '<div class="no-alerts">æ³¨æ„ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</div>';
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ä½œæˆ
        function createAlertCard(alert, type) {
            const icon = type === 'critical' ? 'ğŸ”´' : 'âš ï¸';
            
            return `
                <div class="alert-card ${type}">
                    <div class="alert-card-header">
                        <span class="alert-type">${icon} ${alert.metric || 'ã‚¢ãƒ©ãƒ¼ãƒˆ'}</span>
                        <span class="alert-time">${formatTime(alert.timestamp || alert.triggeredAt)}</span>
                    </div>
                    <div class="alert-message">${alert.message || 'ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'}</div>
                </div>
            `;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(alerts, lastCheck) {
            const activeCountElement = document.getElementById('active-count');
            const lastCheckElement = document.getElementById('last-check');
            
            if (activeCountElement) {
                activeCountElement.textContent = alerts.length;
            }
            
            if (lastCheckElement) {
                lastCheckElement.textContent = formatTime(lastCheck);
            }
        }

        // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return '-';
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            document.getElementById('warning-alerts').innerHTML = `<div class="no-alerts">âŒ ${message}</div>`;
        }

        // ã‚´ãƒ¼ãƒ«è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
        function openGoalSettings() {
            loadCurrentGoals();
            document.getElementById('goalSettingsModal').style.display = 'flex';
        }

        function closeGoalSettings() {
            document.getElementById('goalSettingsModal').style.display = 'none';
        }

        function loadCurrentGoals() {
            try {
                const stored = localStorage.getItem('alert_goals');
                const defaultGoals = {
                    'äºˆç®—æ¶ˆåŒ–ç‡': 80,
                    'CTR': 2.0,
                    'CV': 1,
                    'CPA': 10000,
                    'æ—¥äºˆç®—': 50000,
                    'CPM': 1000
                };
                
                const goals = stored ? JSON.parse(stored) : defaultGoals;
                
                document.getElementById('goal-budget-rate').value = goals['äºˆç®—æ¶ˆåŒ–ç‡'] || 80;
                document.getElementById('goal-ctr').value = goals['CTR'] || 2.0;
                document.getElementById('goal-cv').value = goals['CV'] || 1;
                document.getElementById('goal-cpa').value = goals['CPA'] || 10000;
                document.getElementById('goal-daily-budget').value = goals['æ—¥äºˆç®—'] || 50000;
                document.getElementById('goal-cpm').value = goals['CPM'] || 1000;
            } catch (error) {
                console.error('ã‚´ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function saveGoalSettings() {
            try {
                const goals = {
                    'äºˆç®—æ¶ˆåŒ–ç‡': parseFloat(document.getElementById('goal-budget-rate').value) || 80,
                    'CTR': parseFloat(document.getElementById('goal-ctr').value) || 2.0,
                    'CV': parseInt(document.getElementById('goal-cv').value) || 1,
                    'CPA': parseInt(document.getElementById('goal-cpa').value) || 10000,
                    'æ—¥äºˆç®—': parseInt(document.getElementById('goal-daily-budget').value) || 50000,
                    'CPM': parseInt(document.getElementById('goal-cpm').value) || 1000
                };
                
                localStorage.setItem('alert_goals', JSON.stringify(goals));
                closeGoalSettings();
                
                // ç¾åœ¨ã®ã‚´ãƒ¼ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
                updateCurrentGoalDisplay(goals);
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å†ãƒã‚§ãƒƒã‚¯
                loadAlertData();
                
                alert('ã‚´ãƒ¼ãƒ«è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚´ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function updateCurrentGoalDisplay(goals, goalType = '') {
            // ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—ã®è¡¨ç¤ºåã‚’å–å¾—
            const goalTypeNames = {
                'toC_newsletter': 'toCï¼ˆãƒ¡ãƒ«ãƒã‚¬ç™»éŒ²ï¼‰',
                'toC_line': 'toCï¼ˆLINEç™»éŒ²ï¼‰',
                'toC_phone': 'toCï¼ˆé›»è©±ãƒœã‚¿ãƒ³ï¼‰',
                'toC_purchase': 'toCï¼ˆè³¼å…¥ï¼‰',
                'toB_newsletter': 'toBï¼ˆãƒ¡ãƒ«ãƒã‚¬ç™»éŒ²ï¼‰',
                'toB_line': 'toBï¼ˆLINEç™»éŒ²ï¼‰',
                'toB_phone': 'toBï¼ˆé›»è©±ãƒœã‚¿ãƒ³ï¼‰',
                'toB_purchase': 'toBï¼ˆè³¼å…¥ï¼‰'
            };
            
            const goalTypeName = goalTypeNames[goalType] || goalType || 'æœªè¨­å®š';
            
            const goalText = Object.entries(goals)
                .map(([metric, value]) => {
                    const unit = metric.includes('ç‡') || metric === 'CTR' ? '%' : 
                               metric === 'CPA' || metric === 'æ—¥äºˆç®—' || metric === 'CPM' ? 'å††' : 'ä»¶';
                    return `${metric}: ${value}${unit}`;
                })
                .join(', ');
            
            const currentGoalElement = document.getElementById('current-goal');
            if (currentGoalElement) {
                currentGoalElement.innerHTML = `
                    <strong>ã‚´ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—:</strong> ${goalTypeName}<br>
                    <strong>ç›®æ¨™å€¤:</strong> ${goalText}
                `;
            }
        }

        // åˆæœŸåŒ–æ™‚ã«ã‚´ãƒ¼ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆé‡è¤‡å‰Šé™¤ï¼šä¸Šè¨˜ã§æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ä¸è¦ï¼‰
    </script>
</body>
</html> 