# 毎朝9時の日次レポート通知が送られない問題 - 最終調査報告書

## 調査日
2025年12月29日

## 問題の概要
毎朝9時に送られるはずの日次レポート（前日のデータ）がChatworkに送られなくなっている。
- **12月27日までは正常に届いていた**
- **12月28日（日曜日）以降、送られなくなった**
- **9時のアラート通知は正常に送信されている**
- **広告配信を停止したときに起きた可能性がある**

### ユーザーが期待している日次レポートのフォーマット
```
Meta広告 日次レポート (2025/12/26)

消化金額（合計）：2,777円
予算消化率（平均）：100%
CTR（平均）：3.6%
CPM（平均）：2,926円 
CPA（平均）：2,777円
フリークエンシー（平均）：1.1
コンバージョン数：1件

確認はこちら
https://meta-ads-dashboard.onrender.com/dashboard
```

**重要**: 
- 前日比データ（比較データ）は不要
- 単純に前日のデータを表示する
- 広告配信が止まっても、ゼロとして表示する
- マルチアカウント連携の場合も、それぞれのアカウントに9時に送信する
- 仕様、デザイン、UI、全ての機能、通知内容は一切変更しない

## 現状の仕組み・仕様

### 1. スケジューラーの構成

#### scheduler.js（メインスケジューラー）
- **9時のスケジュール** (`scheduler.js` 678-726行目)
  - データ取得（通知なし）
  - 日次レポート送信 (`sendDailyReportToAllUsers()`)
  - アラート通知送信 (`sendAlertNotificationToAllUsers()`)

#### utils/multiUserChatworkSender.js（マルチユーザー対応送信クラス）
- **`sendDailyReportToAllUsers()`** (`utils/multiUserChatworkSender.js` 817-830行目)
  - 全アクティブユーザーに対して日次レポートを送信
  - 各ユーザーに対して `sendUserDailyReport()` を呼び出す

- **`sendUserDailyReport()`** (`utils/multiUserChatworkSender.js` 72-188行目)
  - メインアカウントの日次レポートを送信
  - 追加アカウント（`additional_accounts`）がある場合、`sendAccountDailyReport()` を呼び出す

- **`sendAccountDailyReport()`** (`utils/multiUserChatworkSender.js` 191-247行目)
  - 追加アカウント専用の日次レポートを送信
  - 各追加アカウントに対して個別に送信

## 問題の原因

### 根本原因: データが0または空の場合、日次レポートが送信されない

**問題のコード箇所1: `sendUserDailyReport()`** (`utils/multiUserChatworkSender.js` 128-131行目)
```javascript
if (!metaData || metaData.length === 0) {
    console.log(`ユーザー${userSettings.user_id}: データなし`);
    return;  // ← ここで処理が中断される
}
```

**問題のコード箇所2: `sendAccountDailyReport()`** (`utils/multiUserChatworkSender.js` 199-202行目)
```javascript
if (!metaData || metaData.length === 0) {
    console.log(`  ⚠️ 追加アカウント ${account.id}: データなし`);
    return;  // ← ここで処理が中断される
}
```

### 詳細分析

1. **広告配信を停止した場合の影響**
   - Meta APIからデータを取得する際、広告配信が停止していると、データが0または空になる可能性がある
   - `fetchMetaAdDailyStats()` が空の配列を返すか、データが0のオブジェクトを返す可能性がある
   - 現在のコードでは、`!metaData || metaData.length === 0` の場合、処理を中断している

2. **マルチアカウント連携時の処理**
   - メインアカウントと追加アカウント（`additional_accounts`）の両方で、データが0の場合に送信されない
   - 176-183行目で追加アカウントにも送信する処理は実装されているが、データが0の場合は送信されない

3. **データが0の場合の期待される動作**
   - データが0でも、日次レポートを送信する
   - 数値は0として表示する（例：「消化金額（合計）：0円」）
   - 既存のフォーマットを維持する

### なぜ12月28日以降送られなくなったのか

**広告配信を停止したことで、以下の連鎖が発生した可能性が高い**：

1. **広告配信停止** → Meta APIからデータが0または空になる
2. **データが0または空** → `!metaData || metaData.length === 0` の条件に該当
3. **処理が中断** → 日次レポートが送信されない
4. **マルチアカウント連携の場合も同様** → すべてのアカウントで送信されない

## 修正方針

### 修正の前提条件
- **仕様、デザイン、UI、全ての機能、通知内容は一切変更しない**
- 既存のフォーマットを完全に維持する
- データが0の場合でも、既存のフォーマットで「0円」「0%」「0件」として表示する

### 修正箇所

#### 修正1: `sendUserDailyReport()` メソッドの修正

**修正前** (`utils/multiUserChatworkSender.js` 128-131行目):
```javascript
if (!metaData || metaData.length === 0) {
    console.log(`ユーザー${userSettings.user_id}: データなし`);
    return;
}
```

**修正後**:
```javascript
// データが0または空の場合でも、デフォルト値で送信する
if (!metaData || metaData.length === 0) {
    console.log(`ユーザー${userSettings.user_id}: データなし（0として送信）`);
    // デフォルト値（0）でデータを作成
    metaData = [{
        spend: 0,
        budgetRate: 0,
        ctr: 0,
        cpm: 0,
        cpa: 0,
        frequency: 0,
        conversions: 0
    }];
}
```

#### 修正2: `sendAccountDailyReport()` メソッドの修正

**修正前** (`utils/multiUserChatworkSender.js` 199-202行目):
```javascript
if (!metaData || metaData.length === 0) {
    console.log(`  ⚠️ 追加アカウント ${account.id}: データなし`);
    return;
}
```

**修正後**:
```javascript
// データが0または空の場合でも、デフォルト値で送信する
if (!metaData || metaData.length === 0) {
    console.log(`  ⚠️ 追加アカウント ${account.id}: データなし（0として送信）`);
    // デフォルト値（0）でデータを作成
    metaData = [{
        spend: 0,
        budgetRate: 0,
        ctr: 0,
        cpm: 0,
        cpa: 0,
        frequency: 0,
        conversions: 0
    }];
}
```

### 修正の効果

1. **広告配信が停止していても、日次レポートが送信される**
   - データが0の場合でも、既存のフォーマットで「0円」「0%」「0件」として表示される

2. **マルチアカウント連携の場合も、すべてのアカウントに送信される**
   - メインアカウントと追加アカウントの両方で、データが0でも送信される

3. **既存のフォーマットを完全に維持**
   - メッセージのフォーマット、デザイン、UIは一切変更しない
   - 数値が0の場合でも、既存の表示形式を維持する

## 修正の実現可能性

### ✅ 可能です

**理由**:
1. **既存のフォーマットを維持できる**
   - メッセージ生成部分（153-164行目、222-233行目）は変更不要
   - データが0の場合でも、既存のフォーマットで表示される

2. **最小限の修正で対応可能**
   - データチェック部分（128-131行目、199-202行目）のみを修正
   - 他の機能や通知内容には影響しない

3. **マルチアカウント連携も対応可能**
   - メインアカウントと追加アカウントの両方で同じ修正を適用
   - 既存の処理フローを維持できる

4. **既存の機能への影響なし**
   - アラート通知、更新通知、その他の通知は一切変更しない
   - 日次レポートのフォーマットも変更しない

## まとめ

毎朝9時の日次レポート通知が送られない原因は、**データが0または空の場合に処理が中断される**ことです。

### 根本原因
- `sendUserDailyReport()` と `sendAccountDailyReport()` で、データが0または空の場合に `return` で処理を中断している
- 広告配信を停止したことで、データが0になり、日次レポートが送信されなくなった

### 修正方針
- データが0または空の場合でも、デフォルト値（0）でデータを作成して送信する
- 既存のフォーマット、デザイン、UI、全ての機能、通知内容は一切変更しない
- マルチアカウント連携の場合も、すべてのアカウントに送信される

### 修正の実現可能性
**✅ 可能です** - 最小限の修正で対応可能で、既存の機能への影響はありません。

