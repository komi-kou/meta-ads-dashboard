# 毎朝9時の前日比データ通知が送られない問題 - 調査報告書

## 調査日
2025年12月29日

## 問題の概要
毎朝9時に送られるはずの前日比データ結果がChatworkに送られなくなっている。
- **12月27日までは正常に届いていた**
- **12月28日（日曜日）以降、送られなくなった**
- **9時のアラート通知は正常に送信されている**
- **日次レポートは送信されているが、前日比データが含まれていない**

### ユーザーが期待している日次レポートのフォーマット
```
Meta広告 日次レポート (2025/12/26)

消化金額（合計）：2,777円
予算消化率（平均）：100%
CTR（平均）：3.6%
CPM（平均）：2,926円 
CPA（平均）：2,777円
フリークエンシー（平均）：1.1
コンバージョン数：1件

確認はこちら
https://meta-ads-dashboard.onrender.com/dashboard
```

**重要**: この日次レポートに、以前は前日比データ（前日と前々日の比較）が含まれていたはずです。

## 現状の仕組み・仕様

### 1. スケジューラーの構成

#### scheduler.js（メインスケジューラー）
- **9時のスケジュール** (`scheduler.js` 678-726行目)
  - データ取得（通知なし）
  - 日次レポート送信 (`sendDailyReportToAllUsers()`)
  - アラート通知送信 (`sendAlertNotificationToAllUsers()`)
  - **前日比データの送信処理は含まれていない**

- **12時、15時、17時、19時のスケジュール** (`scheduler.js` 729-779行目)
  - データ取得（通知なし）
  - 更新通知送信 (`sendUpdateNotificationToAllUsers()`)
  - アラート通知送信 (`sendAlertNotificationToAllUsers()`)

#### dayOverDayScheduler.js（前日比専用スケジューラー）
- **10時のスケジュール** (`dayOverDayScheduler.js` 182-187行目)
  - 前日比アラートチェック実行 (`runDayOverDayCheck()`)
  - 前日比データの送信処理あり

- **15時のスケジュール** (`dayOverDayScheduler.js` 190-195行目)
  - 前日比アラートチェック実行 (`runDayOverDayCheck()`)
  - 前日比データの送信処理あり

### 2. 前日比データ送信の処理フロー

1. **データ取得** (`dayOverDayScheduler.js` 16-85行目)
   - `fetchComparisonData()` メソッドで当日と前日のデータを取得
   - Meta APIから直接データを取得

2. **アラートチェック** (`dayOverDayScheduler.js` 90-127行目)
   - `runDayOverDayCheck()` メソッドで前日比アラートをチェック
   - `checkDayOverDayAlerts()` で各メトリクスを比較

3. **通知送信** (`dayOverDayScheduler.js` 132-168行目)
   - `sendDayOverDayAlerts()` メソッドでChatworkに送信
   - アラートが検出された場合のみ送信

### 3. スケジューラーの起動

`app.js` 6698-6712行目で前日比スケジューラーが起動される：
```javascript
const dayOverDayScheduler = new DayOverDayScheduler(chatworkSender);
dayOverDayScheduler.startScheduler();
```

## 問題の原因

### 根本原因（2つの問題が判明）

#### 問題1: 9時のスケジュールに前日比データ送信処理が実装されていない
- `dayOverDayScheduler.js` では**10時と15時**にのみ実行されるように設定されている
- 9時のスケジュールは設定されていない
- `scheduler.js` の9時のスケジュールにも前日比データ送信処理が含まれていない

#### 問題2: アラートが0件の場合、前日比データが送信されない
- `dayOverDayScheduler.js` の `runDayOverDayCheck()` メソッド（107-119行目）を見ると：
  - **アラートが検出された場合（`alerts.length > 0`）のみ送信される**
  - アラートが0件の場合は「前日比で大きな変化はありませんでした」とログに出力するだけで、**何も送信しない**

### 詳細分析

1. **前日比スケジューラーの実行時刻**
   - `dayOverDayScheduler.js` の `startScheduler()` メソッド（173-200行目）では：
     - 10時に実行（182-187行目）
     - 15時に実行（190-195行目）
     - **9時のスケジュールは設定されていない**

2. **前日比データ送信の条件**
   - `dayOverDayScheduler.js` の `runDayOverDayCheck()` メソッド（90-127行目）では：
     - アラートが検出された場合のみ `sendDayOverDayAlerts()` を呼び出す（107-116行目）
     - アラートが0件の場合は何も送信しない（117-119行目）

3. **scheduler.jsの9時処理**
   - `scheduler.js` の9時のスケジュール（678-726行目）には以下の処理のみが含まれている：
     - データ取得
     - 日次レポート送信
     - アラート通知送信
   - **前日比データの送信処理が含まれていない**

### なぜ12月28日以降送られなくなったのか（根本原因の特定）

**重要情報**：
- 9時のスケジューラーは正常に動作している（アラートは送信されている）
- 9時の前日比データは以前は送信されていた
- 12月27日までは正常に届いていた
- 一つの広告配信を停止したときに起きた可能性

#### 根本原因1: 日次レポートに前日比データが含まれていない

**現状のコード確認結果**（`utils/multiUserChatworkSender.js` 153-164行目）：
- `sendUserDailyReport()` メソッドでは、**前日のデータだけを取得して表示している**
- 前日比データ（前日と前々日の比較）が**含まれていない**
- メッセージには前日のデータのみが表示されている

**コードの現状**：
```javascript
// 前日のデータのみを取得
const metaData = await fetchMetaAdDailyStats({
    accessToken: userSettings.meta_access_token,
    accountId: userSettings.meta_account_id,
    datePreset: 'yesterday'  // 前日のみ
});

const message = `Meta広告 日次レポート (${yesterdayStr})
消化金額（合計）：${Math.round(data.spend || 0).toLocaleString()}円
...（前日のデータのみ）
`;
```

**以前は前日比データが含まれていた理由の推測**：
- 以前のコードでは、前々日のデータも取得して、前日比データを日次レポートに含めていた可能性
- または、`dayOverDayScheduler.js` の `runDayOverDayCheck()` を呼び出して、前日比データを日次レポートに追加していた可能性
- コードの更新やリファクタリングにより、前日比データを日次レポートに追加する処理が削除された可能性

### 根本原因2: 9時のスケジュールに前日比データ送信処理が実装されていない

**現状のコード確認結果**：
- `scheduler.js` の9時のスケジュール（678-726行目）には、前日比データ送信処理が**含まれていない**
- `dayOverDayScheduler.js` の `startScheduler()` では、10時と15時にのみ実行されるように設定されている
- **9時のスケジュールは設定されていない**

**以前は9時に送信されていた理由の推測**：
- 以前のコードでは、9時のスケジュールに前日比データ送信処理が含まれていた可能性
- または、日次レポート送信時に前日比データを追加していた可能性
- コードの更新やリファクタリングにより、9時の前日比送信処理が削除された可能性

#### 根本原因2: 広告配信停止によるデータ取得の問題

**問題のロジック**（`dayOverDayScheduler.js` 42行目）：
```javascript
if (!currentData || currentData.spend === 0) {
    console.log('⚠️ 当日のデータがまだ利用できません');
    // 当日データがない場合は、前日と前々日を比較
    ...
}
```

**広告配信を停止した場合の影響**：
1. **当日のデータが0になる** → `currentData.spend === 0` の条件に該当
2. **前日と前々日を比較するロジックにフォールバック**（44-64行目）
3. **前日も0の場合、データ取得に失敗する可能性**（67-69行目）
4. **データ取得に失敗すると、`comparisonData`が`null`になり、処理が中止される**（96-99行目）

#### 根本原因3: 前日データが0の場合、アラートが発生しない

**問題のロジック**（`dayOverDayAlertSystem.js` 78行目）：
```javascript
if (!previousValue || previousValue === 0) {
    console.log(`⚠️ ${metric}: 前日データなしのためスキップ`);
    return null;
}
```

**広告配信を停止した場合の影響**：
1. **前日データが0の場合、アラートチェックがスキップされる**
2. **アラートが0件になる**
3. **アラートが0件の場合、前日比データが送信されない**（`dayOverDayScheduler.js` 117-119行目）

#### 根本原因4: アラートが0件の場合、前日比データが送信されない

**問題のロジック**（`dayOverDayScheduler.js` 107-119行目）：
```javascript
if (alerts.length > 0) {
    // アラートが検出された場合のみ送信
    await this.sendDayOverDayAlerts(alerts, dates);
} else {
    console.log('✅ 前日比で大きな変化はありませんでした');
    // アラートが0件の場合、何も送信しない
}
```

**影響**：
- 広告配信を停止した場合、前日データが0になり、アラートが発生しない
- アラートが0件のため、前日比データが送信されない
- **以前は、アラートが0件でも前日比データが送信されていた可能性が高い**

### 12月28日以降送られなくなった理由の推測

1. **広告配信を停止したことで、データが0になった**
   - 当日のデータが0になり、前日と前々日を比較するロジックにフォールバック
   - 前日も0の場合、データ取得に失敗する可能性

2. **前日データが0の場合、アラートが発生しない**
   - `checkMetricDayOverDay()` で前日データが0の場合、アラートチェックがスキップされる
   - アラートが0件になる

3. **アラートが0件の場合、前日比データが送信されない**
   - `runDayOverDayCheck()` でアラートが0件の場合、何も送信しない
   - **以前は、アラートが0件でも前日比データが送信されていた可能性が高い**

4. **9時のスケジュールに前日比データ送信処理が実装されていない**
   - 現在のコードでは、9時に前日比データが送信されない
   - 以前は、別の方法で9時に前日比データが送信されていた可能性

## 改善策

### 推奨改善策1: scheduler.jsの9時処理に前日比送信を追加 + アラートが0件でも送信するように修正

**実装方法**:
1. `scheduler.js` の9時のスケジュール処理内に、前日比データ送信処理を追加する
2. `dayOverDayScheduler.js` の `runDayOverDayCheck()` メソッドを修正し、アラートが0件でも前日比データを送信するようにする

**具体的な修正箇所1: scheduler.js**
```javascript
// scheduler.js 678-726行目の9時スケジュール内に追加

// マルチユーザー前日比データ送信（9時）
await executionManager.executeGlobalTask('morning_day_over_day', async () => {
  try {
    writeLog('朝9時の前日比データ送信開始');
    const DayOverDayScheduler = require('./dayOverDayScheduler');
    const ChatworkAutoSender = require('./chatworkAutoSender');
    const chatworkSender = new ChatworkAutoSender();
    const dayOverDayScheduler = new DayOverDayScheduler(chatworkSender);
    
    // 全ユーザーに対して前日比チェックを実行
    const UserManager = require('./userManager');
    const userManager = new UserManager();
    const allUsers = userManager.getAllUsers();
    
    for (const user of allUsers) {
      const userSettings = userManager.getUserSettings(user.id);
      if (userSettings && userSettings.enable_scheduler) {
        await dayOverDayScheduler.runDayOverDayCheck(user.id);
      }
    }
    
    writeLog('朝9時の前日比データ送信完了');
  } catch (error) {
    writeLog('前日比データ送信エラー: ' + error.message);
  }
});
```

**具体的な修正箇所2: dayOverDayScheduler.js**
```javascript
// dayOverDayScheduler.js の runDayOverDayCheck() メソッド（90-127行目）を修正

async runDayOverDayCheck(userId = null) {
    console.log('=== 前日比アラートチェック実行開始 ===');
    
    try {
        // データを取得
        const comparisonData = await this.fetchComparisonData(userId);
        if (!comparisonData) {
            console.log('⚠️ データ取得失敗のため処理を中止');
            return [];
        }

        const { current, previous, dates } = comparisonData;
        console.log(`📊 比較期間: ${dates.previous} → ${dates.current}`);

        // アラートチェック
        const alerts = await checkDayOverDayAlerts(current, previous, userId);

        // 【重要】アラートが0件でも前日比データを送信するように修正
        if (alerts.length > 0) {
            console.log(`🚨 ${alerts.length}件の前日比アラートを検出`);
            
            // アラート履歴に保存
            await saveAlertHistory(alerts);

            // チャットワーク通知（ChatworkAutoSenderが設定されている場合）
            if (this.chatworkAutoSender) {
                await this.sendDayOverDayAlerts(alerts, dates);
            }
        } else {
            console.log('✅ 前日比で大きな変化はありませんでした');
            
            // 【追加】アラートが0件でも前日比データを送信
            if (this.chatworkAutoSender) {
                await this.sendDayOverDaySummary(current, previous, dates);
            }
        }

        return alerts;

    } catch (error) {
        console.error('❌ 前日比アラートチェックエラー:', error);
        return [];
    }
}

// 【追加】前日比サマリー送信メソッド（アラートが0件の場合）
async sendDayOverDaySummary(current, previous, dates) {
    try {
        let message = `📊 Meta広告 前日比レポート
比較期間: ${dates.previous} → ${dates.current}

前日比で大きな変化はありませんでした。

【前日データ】
消化金額: ${(previous.spend || 0).toLocaleString()}円
CTR: ${(previous.ctr || 0).toFixed(2)}%
CPM: ${Math.round(previous.cpm || 0).toLocaleString()}円
CPA: ${(previous.cpa || 0).toLocaleString()}円
CV: ${(previous.conversions || 0)}件

【当日データ】
消化金額: ${(current.spend || 0).toLocaleString()}円
CTR: ${(current.ctr || 0).toFixed(2)}%
CPM: ${Math.round(current.cpm || 0).toLocaleString()}円
CPA: ${(current.cpa || 0).toLocaleString()}円
CV: ${(current.conversions || 0)}件

詳細確認：https://meta-ads-dashboard.onrender.com/dashboard`;

        await this.chatworkAutoSender.sendMessage(message);
        console.log('✅ 前日比サマリーをチャットワークに送信しました');
    } catch (error) {
        console.error('❌ 前日比サマリー送信エラー:', error);
    }
}
```

**メリット**:
- 既存のスケジューラー構造を維持できる
- 9時の処理に統一感を持たせられる
- アラートが0件でも前日比データが送信される
- 他の時間帯の処理と一貫性がある

**デメリット**:
- `dayOverDayScheduler.js` のスケジュール設定（10時、15時）と重複する可能性がある
- 新しいメソッド `sendDayOverDaySummary()` の実装が必要

### 推奨改善策2: dayOverDayScheduler.jsに9時のスケジュールを追加

**実装方法**:
`dayOverDayScheduler.js` の `startScheduler()` メソッドに9時のスケジュールを追加する。

**具体的な修正箇所**:
```javascript
// dayOverDayScheduler.js 173-200行目のstartScheduler()メソッド内に追加

// 毎日午前9時に実行（朝のレポート送信）
cron.schedule('0 9 * * *', async () => {
    console.log('📅 朝9時の前日比アラートチェック実行');
    await this.runDayOverDayCheck();
}, {
    timezone: 'Asia/Tokyo'
});
```

**メリット**:
- 前日比関連の処理を一箇所に集約できる
- 既存のスケジューラー構造を変更する必要がない

**デメリット**:
- `scheduler.js` と `dayOverDayScheduler.js` の両方で9時のスケジュールが設定されるため、重複実行のリスクがある

### 推奨改善策3: MultiUserChatworkSenderに前日比送信メソッドを追加

**実装方法**:
`utils/multiUserChatworkSender.js` に前日比データ送信用のメソッドを追加し、`scheduler.js` の9時処理から呼び出す。

**メリット**:
- マルチユーザー対応が容易
- 既存の送信処理と統一された構造になる

**デメリット**:
- 新しいメソッドの実装が必要
- `dayOverDayScheduler.js` との統合が必要

## 推奨される修正方針

**推奨: 改善策1（scheduler.jsの9時処理に前日比送信を追加 + アラートが0件でも送信するように修正）**

理由:
1. 既存のスケジューラー構造を維持できる
2. 9時の処理に統一感を持たせられる
3. **アラートが0件でも前日比データが送信される**（重要）
4. 他の時間帯の処理と一貫性がある
5. マルチユーザー対応が既に実装されている

ただし、以下の点に注意が必要:
- `dayOverDayScheduler.js` の10時、15時のスケジュールと重複しないようにする
- 前日比データが既に送信済みかどうかのチェックを実装する
- エラーハンドリングを適切に実装する
- **アラートが0件の場合の送信メッセージフォーマットを決定する**

## 追加の調査が必要な項目

1. **過去のログ確認**
   - 過去に9時の前日比データが送信されていたかどうかを確認
   - `scheduler.log` やサーバーログを確認

2. **ユーザー設定の確認**
   - ユーザーごとに前日比通知の有効/無効設定があるか確認
   - `userManager.js` や `user_settings.json` を確認

3. **環境変数の確認**
   - 前日比通知に関連する環境変数があるか確認
   - 環境変数の変更履歴を確認

## まとめ

毎朝9時の前日比データ通知が送られない原因は、**5つの根本原因**が複合的に作用していることが判明しました：

### 根本原因1: 日次レポートに前日比データが含まれていない（最重要）
- `utils/multiUserChatworkSender.js` の `sendUserDailyReport()` メソッドでは、前日のデータだけを取得して表示している
- 前日比データ（前日と前々日の比較）が含まれていない
- **以前は日次レポートに前日比データが含まれていたが、現在のコードには実装されていない**

### 根本原因2: 9時のスケジュールに前日比データ送信処理が実装されていない
- `dayOverDayScheduler.js` では10時と15時に前日比アラートが実行されるように設定されているが、9時のスケジュールは設定されていない
- `scheduler.js` の9時の処理にも前日比データ送信処理が含まれていない
- **以前は9時に前日比データが送信されていたが、現在のコードには実装されていない**

### 根本原因2: 広告配信停止によるデータ取得の問題
- 広告配信を停止したことで、当日のデータが0になった
- `currentData.spend === 0` の条件に該当し、前日と前々日を比較するロジックにフォールバック
- 前日も0の場合、データ取得に失敗する可能性がある

### 根本原因3: 前日データが0の場合、アラートが発生しない
- `checkMetricDayOverDay()` で前日データが0の場合、アラートチェックがスキップされる
- アラートが0件になる

### 根本原因4: アラートが0件の場合、前日比データが送信されない
- `runDayOverDayCheck()` でアラートが0件の場合、何も送信しない
- **以前は、アラートが0件でも前日比データが送信されていた可能性が高い**

### 12月27日までは届いていた理由の推測
1. **以前は9時に前日比データが送信されていた**
   - 以前のコードでは、9時のスケジュールに前日比データ送信処理が含まれていた可能性
   - または、別のプロセスやスクリプトで9時に前日比データが送信されていた可能性

2. **以前はアラートが0件でも前日比データが送信されていた**
   - 以前の実装では、アラートの有無に関わらず前日比データが送信されていた可能性
   - 現在の実装では、アラートが0件の場合は何も送信されない

3. **広告配信を停止したことで、データが0になり、アラートが発生しなくなった**
   - 12月28日以降、広告配信を停止したことで、データが0になった
   - 前日データが0の場合、アラートチェックがスキップされる
   - アラートが0件になり、前日比データが送信されなくなった

### 推奨される修正（優先順位順）

#### 最優先: 日次レポートに前日比データを追加する
1. **`utils/multiUserChatworkSender.js` の `sendUserDailyReport()` メソッドを修正する**
   - 前々日のデータも取得する
   - 前日と前々日のデータを比較して、前日比データを日次レポートに追加する
   - 変化率や変化量を表示する

**具体的な修正方法**：
- 前々日のデータを取得（`datePreset: 'day_before_yesterday'` または日付指定）
- 前日と前々日のデータを比較
- 日次レポートのメッセージに前日比データを追加
  - 例：「消化金額（合計）：2,777円（前日比: +15.2%）」

#### 優先度2: アラートが0件でも前日比データを送信する
2. **`dayOverDayScheduler.js` の `runDayOverDayCheck()` メソッドを修正し、アラートが0件でも前日比データを送信するようにする**
   - アラートが0件の場合でも、前日比サマリーを送信する

#### 優先度3: 9時のスケジュールに前日比データ送信処理を追加する
3. **`scheduler.js` の9時のスケジュール処理内に前日比データ送信処理を追加する**
   - 9時に前日比データが送信されるようにする（日次レポートに含める場合は不要）

#### 優先度4: 広告配信停止時のデータ取得ロジックを改善する
4. **広告配信停止時のデータ取得ロジックを改善する**
   - データが0の場合でも、前日比データを送信できるようにする

これにより、9時に日次レポートに前日比データが含まれて送信されるようになり、アラートが0件でも前日比データが送信されるようになります。

